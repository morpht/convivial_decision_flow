class DecisionTree{"use strict";constructor(id){this._validation(id);const steps=this._loadSteps(id);if(Array.isArray(steps)){this.config={id:id,first_step:steps[0],steps:steps};if(!this._isLocalStorageAvailable()){return}this.storage=this._loadStorage(id);this.activate();this.initializeForms();document.querySelectorAll("#"+id+" .step .step__answer").forEach(function(answer){if(answer.hasAttribute("href")){answer.addEventListener("click",()=>{this.filter();this.trackAnswer(answer.attributes.href.value.replace("#",""),answer.hasAttribute("data-answer-path")?answer.attributes["data-answer-path"].value:false)})}},this)}else{throw new Error("Please follow proper HTML structure.")}}_isLocalStorageAvailable(){try{if(typeof localStorage==="undefined"){return false}var test="test";localStorage.setItem(test,test);localStorage.removeItem(test);return true}catch(e){console.log("Decision tree will not work optimally because the browser local storage is not enabled or accessible.");return false}}_loadSteps(id){const steps=[];document.querySelector("#"+id).querySelectorAll(".step").forEach(function(el,index){steps.push(el.id)});if(steps.length<1){console.warn("Decision tree should have at least one step.")}return steps}_validateHistory(storage){const history=storage[this.config.id].history??"";const steps=this.config.steps?this.config.steps:this._loadSteps(this.config.id);if(history.length>0&&steps.length>0){const valid=history.every(function(val){return steps.indexOf(val)!==-1});if(valid===false){storage[this.config.id].history=[this.config.first_step];storage[this.config.id].active=this.config.first_step;this.storage=storage;this._saveStorage()}}return storage}_loadStorage(id){let namespace=`decision-tree.${id}`;let storage=JSON.parse(localStorage.getItem(namespace))||{};if(storage[id]!==undefined){storage=this._validateHistory(storage);if(!storage[id].vars){storage[id].vars={}}this.storage=storage[id];return storage[id]}this.storage={first_step:this.config.first_step,active:this.config.first_step,history:[this.config.first_step],vars:{}};return this.storage}_saveStorage(){let namespace=`decision-tree.${this.config.id}`;let storage=JSON.parse(localStorage.getItem(namespace))||{};storage[this.config.id]=this.storage;localStorage.setItem(namespace,JSON.stringify(storage));this.storage=storage[this.config.id]}_validation(id){const steps=document.querySelector("#"+id).querySelectorAll(".step");steps.forEach(function(el,index){if(!el.hasAttribute("id")){console.warn("One of your steps in decision tree with ID "+id+" does not have ID element filled.")}});document.querySelector("#"+id).querySelectorAll(".step__answer").forEach(function(el,index){if(!el.hasAttribute("href")){console.warn("One of your answers in decision tree id "+id+" does not have href filled.")}if(!el.hasAttribute("data-answer-path")){console.warn("One of your answers in decision tree id "+id+" does not have data-answer-path filled.")}})}_showSummary(){this._cleanHTML();const display_summary_in_step=document.querySelector("#"+this.config.id+" #"+this.storage.active).hasAttribute("data-show-summary");if(this.storage.active){var furtherQuestions=document.querySelector("#"+this.config.id+" #"+this.storage.active+" .step__answer");if(furtherQuestions!=null){furtherQuestions=furtherQuestions.innerHTML.replace(/<\!--.*?-->/g,"").trim().length}}if(furtherQuestions===0||furtherQuestions==null||display_summary_in_step){this.show("#"+this.config.id+" .decision-tree__summary");let infoHTML="";if(this.storage.history){const history=this.storage.history.slice();history.forEach(el=>{if(document.querySelector("#"+this.config.id+" #"+el+" .step__info")){infoHTML+=document.querySelector("#"+this.config.id+" #"+el+" .step__info").innerHTML}});const summary_element=document.querySelector("#"+this.config.id+" .decision-tree__summary");if(summary_element&&summary_element.nodeType){if(summary_element.querySelector(".decision-tree__summary_infos")!==null){summary_element.querySelector(".decision-tree__summary_infos").innerHTML=infoHTML}else{const divElement=document.createElement("div");divElement.classList.add("decision-tree__summary_infos");divElement.innerHTML=infoHTML;summary_element.appendChild(divElement);this.filter()}}else{console.warn("Your decision tree with ID "+this.config.id+" does not have element with class decision-tree__summary.")}}else{this.hide("#"+this.config.id+" .decision-tree__summary")}this._showHistory();this._showSubmission();document.querySelector("#"+this.config.id+" .decision-tree__history").style.display="block";document.querySelector("#"+this.config.id+" .decision-tree__submission").style.display="block"}}_cleanHTML(){document.querySelectorAll("#"+this.config.id+" .decision-tree__summary_infos *").forEach(function(element){element.remove()});document.querySelectorAll("#"+this.config.id+" .decision-tree__summary").forEach(element=>{element.removeAttribute("style")})}_handleFormSubmit(form){let formData=new FormData(form);let vars={};formData.forEach((value,key)=>{vars[key]=value;let label;form.querySelectorAll("label").forEach(lbl=>{if(lbl.getAttribute("for")===key){label=lbl.textContent.trim()}});if(label){vars[key+"_label"]=label}});let namespace=`decision-tree.${this.config.id}`;let storage=JSON.parse(localStorage.getItem(namespace))||{};if(!storage[this.config.id]){storage[this.config.id]={first_step:this.config.first_step,active:this.config.first_step,history:[this.config.first_step],vars:{}}}storage[this.config.id].vars={...storage[this.config.id].vars,...vars};localStorage.setItem(namespace,JSON.stringify(storage));this.storage=storage[this.config.id];let nextStep=form.getAttribute("action").replace("#","");this.trackAnswer(nextStep);this.filter()}_filterElement(element){let filters=element.getAttribute("data-dt-filter");if(!filters)return true;return filters.split(",").some(filter=>{return filter.split("+").every(criteria=>{if(criteria.startsWith("!")){return!this._evaluateCriteria(criteria.slice(1))}return this._evaluateCriteria(criteria)})})}_evaluateCriteria(criteria){if(criteria.startsWith("var_")){let[variable,operation,value]=criteria.slice(4).split("_");return this._compare(this.storage.vars[variable],operation,value)}else if(criteria.startsWith("visited_")){return this.storage.history.includes(criteria.slice(8))}return false}_compare(variableValue,operator,comparator){if(!isNaN(variableValue))variableValue=parseFloat(variableValue);if(!isNaN(comparator))comparator=parseFloat(comparator);switch(operator){case"gt":return variableValue>comparator;case"gte":return variableValue>=comparator;case"lt":return variableValue<comparator;case"lte":return variableValue<=comparator;case"eq":return variableValue==comparator;case"empty":return variableValue==="";default:return false}}_showHistory(){let historyElement=document.querySelector("#"+this.config.id+" .decision-tree__history");let dlElement=document.createElement("dl");let dtElement=document.createElement("dt");dtElement.textContent="History";dlElement.appendChild(dtElement);this.storage.history.forEach(stepId=>{let stepElement=document.querySelector("#"+this.config.id+" #"+stepId);let titleElement=stepElement.querySelector(".step__heading");let ddElement=document.createElement("dd");ddElement.textContent=titleElement?titleElement.textContent.trim():stepId;dlElement.appendChild(ddElement)});historyElement.innerHTML="<h3>History</h3>";historyElement.appendChild(dlElement)}_showSubmission(){let submissionElement=document.querySelector("#"+this.config.id+" .decision-tree__submission");let submissions=this.storage.vars;let dlElement=document.createElement("dl");Object.keys(submissions).forEach(key=>{if(!key.endsWith("_label")){let label=submissions[key+"_label"]||key;let value=submissions[key];let dtElement=document.createElement("dt");dtElement.textContent=label;let ddElement=document.createElement("dd");ddElement.textContent=this._capitalizeFirstLetter(value);dlElement.appendChild(dtElement);dlElement.appendChild(ddElement)}});submissionElement.innerHTML="<h3>Submission</h3>";submissionElement.appendChild(dlElement)}_capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}activate(){try{this.trackGA(this.storage.active+"/");document.querySelectorAll("#"+this.config.id+" .step").forEach(step=>{this.hide(step)});this.toggleFooter();if(!document.querySelector("#"+this.config.id+" .decision-tree__summary")){const divElement=document.createElement("div");divElement.classList.add("decision-tree__summary");document.querySelector("#"+this.config.id+" .decision-tree__footer").prepend(divElement)}this.show("#"+this.config.id+" #"+this.storage.active);this._showSummary();this.filter();document.querySelector("#"+this.config.id+" .decision-tree__footer .step__button--back").onclick=()=>{this.trackBackButton()};document.querySelector("#"+this.config.id+" .decision-tree__footer .step__button--restart").onclick=()=>{this.trackRestartButton()};document.querySelector("#"+this.config.id).classList.add("dt-initialized");document.querySelector("#"+this.config.id+" .decision-tree__history").style.display="none";document.querySelector("#"+this.config.id+" .decision-tree__submission").style.display="none";this._saveStorage()}catch(e){this.hide("#"+this.config.id);console.warn("Cannot activate decision tree with ID "+this.config.id+". Incorrect HTML structure.")}}initializeForms(){document.querySelectorAll("#"+this.config.id+" .dt-form").forEach(form=>{form.addEventListener("submit",event=>{event.preventDefault();this._handleFormSubmit(form)})})}hide(elem){try{if(typeof elem==="string"){elem=document.querySelector(elem)}if(elem&&elem.nodeType){elem.style.display="none";return true}}catch(e){console.warn("Please check decision tree with ID "+this.config.id+". Incorrect HTML structure.")}return false}show(elem){try{if(typeof elem==="string"){elem=document.querySelector(elem)}if(elem&&elem.nodeType){elem.style.display="block";return true}}catch(e){console.warn("Please check decision tree "+this.config.id+". Incorrect HTML structure.")}return false}filter(){document.querySelectorAll("#"+this.config.id+" [data-dt-filter]").forEach(element=>{if(this._filterElement(element)){this.show(element)}else{this.hide(element)}})}is_in_history(filter_array){return filter_array.split(" ").every(object=>{return this.storage.history.includes(object)})}toggleFooter(){if(!document.querySelector("#"+this.config.id+" .decision-tree__footer")){const divElement=document.createElement("div");divElement.classList.add("decision-tree__footer");divElement.innerHTML="<button class='step__button step__button--back'>Back</button>\n<button class='step__button step__button--restart'>Restart</button>";document.querySelector("#"+this.config.id).appendChild(divElement)}if(this.storage.history&&this.storage.history.length>1){this.show("#"+this.config.id+" .decision-tree__footer")}else{this.hide("#"+this.config.id+" .decision-tree__footer")}}trackAnswer(nextStep,datakey){if(datakey){this.trackGA(this.storage.active+"/"+datakey)}this.hide("#"+this.config.id+" #"+this.storage.active);this.show("#"+this.config.id+" #"+nextStep);this.trackGA(nextStep+"/");this.storage.active=nextStep;this.storage.history.push(this.storage.active);this._saveStorage(this.config.id);this.trackAttribute(nextStep);this._showSummary();this.toggleFooter()}trackBackButton(){if(this.storage.history.length<=1){return}this.hide("#"+this.config.id+" #"+this.storage.active);const previousStep=this.storage.history[this.storage.history.length-2];this.show("#"+this.config.id+" #"+previousStep);this.trackGA(previousStep+"/back");this.hide("#"+this.config.id+" #"+this.storage.active+" .step__info");this._cleanHTML();this.storage.active=previousStep;this.storage.history.pop();this._saveStorage();this.trackAttribute(this.storage.active);this.toggleFooter()}trackRestartButton(){this.hide("#"+this.config.id+" #"+this.storage.active);this.trackGA(this.storage.active+"/restart");this.storage.active=this.config.first_step;this.show("#"+this.config.id+" #"+this.storage.active);this.trackGA(this.storage.active);this.storage.history=[this.config.first_step];this._saveStorage();this.trackAttribute(this.storage.active);this.toggleFooter();this._cleanHTML()}trackAttribute(id){let step=document.querySelector("#"+this.config.id+" #"+id);if(step!=null){let stepOutcome=step.getAttribute("data-cookie");if(stepOutcome!==null){this.cookie(stepOutcome.split("=")[0],stepOutcome.split("=")[1])}}}trackGA(path){if(typeof gtag==="function"&&drupalSettings.google_analytics!==undefined){gtag("config",drupalSettings.google_analytics.account,{page_path:window.location.href+this.config.id+"/"+path})}else if(typeof ga==="function"&&ga.getAll()[0].get("clientId")!==null&&ga.getAll()[0].get("trackingId")!==null){ga("create",ga.getAll()[0].get("trackingId"),{clientId:ga.getAll()[0].get("clientId")});ga("send","pageview",window.location.href+this.config.id+"/"+path)}}cookie(name,value,days){let expires;if(days){const date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);expires=" expires="+date.toGMTString()}else{expires=""}document.cookie=encodeURIComponent(name)+"="+encodeURIComponent(value)+";"+expires+";"+" path=/; SameSite=None; Secure"}}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".decision-tree").forEach(function(el){if(el.hasAttribute("id")){new DecisionTree(el.id)}else{console.warn("Decision tree does not have ID.")}})},false);